# setup.ps1

# 1. Install Scoop (The package manager)
Write-Host "Installing Scoop..." -ForegroundColor Cyan
Set-ExecutionPolicy RemoteSigned -Scope CurrentUser -Force
if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
irm get.scoop.sh | iex
}

# 2. Install The Missing Helpers FIRST ( for 7zip/ innounp)
Write-Host "Installing Helper Tools..." -ForegroundColor Yellow
scoop install 7zip innounp dark

# 3. Install my Main Tools
Write-Host "Installing Neovim, Git, GCC, and github CLI and Ripgrep" -ForegroundColor Green
scoop update
scoop install git neovim ripgrep gcc gh python nodejs fd lua luarocks wezterm

# 3.1 install fonts
scoop bucket add nerd-fonts
scoop install nerd-fonts/Firacode-NF

# 4. Clone my Dotfiles
$RepoPath  = "$HOME\dotfiles"
if (-not (Test-Path $RepoPath)) {
    Write-Host "Cloning Dotfiles from Github..." -ForegroundColor Cyan
    git clone https://github.com/jitumaatgit/dotfiles.git $RepoPath
} else { 
    # if folder exists, just pull latest changes
    Set-Location $RepoPath
    git pull
    Set-Location $HOME
}

# 5. Apply Configurations (the non-admin way)

# --- Neovim: Directory Junction (works w/o admin) ---
Write-Host "Linking Neovim config..." -ForegroundColor Cyan
$NvimLocal = "$env:LOCALAPPDATA\nvim"
if (Test-Path $NvimLocal) { Remove-Item $NvimLocal -Recurse -Force }
New-Item -ItemType Junction -Path $NvimLocal -Target "$RepoPath\nvim"

# --- Git Config: Copy File (bypasses Symlink restriction) ---
# We copy the file because file-symlinks need Admin. 
Copy-Item "$RepoPath\git\.gitconfig" "$HOME\.gitconfig" -Force
# 6. Check GitHub Authentication
Write-Host "Checking Github Authentication..." -ForegroundColor Cyan

# '2>$null' suppresses the error mesage if im not logged in
gh auth status 2>$null
# checks the exit code and list next step if im not logged in
if ($LASTEXITCODE -ne 0) {
    Write-Host "--------------------------------------------------------" -ForegroundColor Yellow
    Write-Host "ACTION REQUIRED: You are not logged into GitHub." -ForegroundColor Yellow
    Write-Host "To push your config changes, please run this command now:"
    Write-Host ""
    Write-Host "  gh auth login"
    Write-Host ""
    Write-Host "This will open a browser to authenticate you for this session."
    Write-Host "--------------------------------------------------------"
} else {
    Write-Host "You are already logged into GitHub." -ForegroundColor Green
}

Write-Host "--- Setup Complete! ---" -ForegroundColor Green
Write-Host "Run 'nvim' to start coding." 
